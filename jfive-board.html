<script>
    // TODO figure out mocking, spieing, or whatever needs to happen to test this component without the jonny-five library connecting to the physical board
    // TODO this is my own mock
    const five = {
        Board: function(options) {
            console.log('Board options received', options)
            this.on = () => {

            };
        }
    };

    class JFiveBoard extends HTMLElement {
        constructor() {
            super();

            // this._boardId;
            // this._port;
            // this._repl = true;
            // this._debug = true;
            // this._timeout = 10;
            this.boardId;
            this.port;
            this.ioPlugin;
            this.repl;
            this.debug;
            this.timeout;
            this.Board;
        }

        static get observedAttributes() {
            return [
                'board-id',
                'port',
                'repl',
                'debug',
                'timeout',
                'io-plugin'
            ];
        }

        attributeChangedCallback(name, oldValue, newValue) {
            switch (name) {
                case 'board-id': {
                    this.boardId = newValue;
                    break;
                }
                case 'port': {
                    this.port = newValue;
                    break;
                }
                case 'repl': {
                    this.repl = newValue === '' || newValue === 'true' ? true : newValue === 'false' ? false : this.repl;
                    break;
                }
                case 'debug': {
                    this.debug = newValue === '' || newValue === 'true' ? true : newValue === 'false' ? false : this.repl;
                    break;
                }
                case 'timeout': {
                    this.timeout = parseInt(newValue, 10);
                    break;
                }
                case 'io-plugin': {
                    this.ioPlugin = newValue;
                    break;
                }
            }
        }

        connectedCallback() {
            // The assumption is that this setTimeout will allow all data-bound properties from the host component to be set on this component
            // before the function inside of the setTimeout is called. In other words, all of this component's properties should be set when this setTimeout function runs
            setTimeout(() => {
                // initialize the board
                this.Board = new five.Board({
                    id: this.boardId,
                    port: this.port,
                    repl: this.repl,
                    debug: this.debug,
                    timeout: this.timeout,
                    io: this.ioPlugin ? new require(this.ioPlugin) : undefined
                });

                // initialize all event handlers, pass the events up to the host element and no further
                this.Board.on('connect', (event) => {
                    this.dispatchEvent(new CustomEvent('connect', {
                        detail: event,
                        bubbles: false
                    }));
                });

                this.Board.on('ready', (event) => {
                    this.dispatchEvent(new CustomEvent('ready', {
                        detail: event,
                        bubbles: false
                    }));
                });

                this.Board.on('exit', (event) => {
                    this.dispatchEvent(new CustomEvent('exit', {
                        detail: event,
                        bubbles: false
                    }));
                });

                this.Board.on('info', (event) => {
                    this.dispatchEvent(new CustomEvent('info', {
                        detail: event,
                        bubbles: false
                    }));
                });

                this.Board.on('warn', (event) => {
                    this.dispatchEvent(new CustomEvent('warn', {
                        detail: event,
                        bubbles: false
                    }));
                });

                this.Board.on('fail', (event) => {
                    this.dispatchEvent(new CustomEvent('fail', {
                        detail: event,
                        bubbles: false
                    }));
                });

                this.Board.on('message', (event) => {
                    this.dispatchEvent(new CustomEvent('message', {
                        detail: event,
                        bubbles: false
                    }));
                });

                // initialize all children
                // TODO We should abstract this into a method of its own...and that method should probably just call a function that we share across all components, because
                // it looks like this is going to be repeated by all children
                const children = Array.from(this.children);
                children.forEach((child) => {
                    if (child._jfiveInit) {
                        child._jfiveInit();
                    }
                });
            });
        }

        // set boardId(val) {
        //     this._boardId = val;
        // }
        //
        // get boardId() {
        //     return this._boardId;
        // }
        //
        // set port(val) {
        //     this._port = val;
        // }
        //
        // get port() {
        //     return this._port;
        // }
        //
        // set repl(val) {
        //     this._repl = val;
        // }
        //
        // get repl() {
        //     return this._repl;
        // }
        //
        // set debug(val) {
        //     this._debug = val;
        // }
        //
        // get debug() {
        //     return this._debug;
        // }
        //
        // set timeout(val) {
        //     this._timeout = val;
        // }
        //
        // get timeout() {
        //     return this._timeout;
        // }
    }

    window.customElements.define('jfive-board', JFiveBoard);
</script>
